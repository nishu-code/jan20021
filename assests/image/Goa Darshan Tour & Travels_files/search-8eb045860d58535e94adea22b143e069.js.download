function VLSearch(e,t){this.url_params=$.deparam(window.location.search.substring(1)),this.filters=this.url_params.filters||{},this.dest=e,this.auto_apply=t}function init_daterange_picker(e,t,r){VL.init_on_ready("search daterange picker",function(){loadjs.ready("air_datepicker",function(){var a=$(e),o=!1;a.datepicker({range:!0,autoClose:!0,minDate:new Date,language:VL.language,multipleDatesSeparator:" - ",onSelect:function(e,r){var a=VL.search_widgets[t];r[0]&&a.set_departure_date_filter("low",r[0]),r[1]&&a.set_departure_date_filter("high",r[1]),2==r.length&&o&&a.do_auto_apply()}});var n=r.dep_date_from,i=r.dep_date_to;n&&i?a.data("datepicker").selectDate([n,i]):n?a.data("datepicker").selectDate([n]):i&&a.data("datepicker").selectDate([i]),o=!0})})}function restructure_search_response(e,t){var r=[];return $.each(e.tab_order,function(t,a){"storefront_routes"==a&&e.storefront_route_total>0?$.each(e.storefront_routes,function(e,t){r.push({group:"storefront_routes",label:t._source.title,data:t,val:Math.floor(1e6*Math.random())+1})}):"trips"==a&&e.trip_total>0?$.each(e.trips,function(e,t){r.push({group:"trips",label:t._source.name,data:t,val:Math.floor(1e6*Math.random())+1})}):"collections"==a&&e.collection_total>0&&$.each(e.collections,function(e,t){r.push({group:"collections",label:t._source.name,data:t,val:Math.floor(1e6*Math.random())+1})})}),r.push({group:"advanced_search",label:t,val:Math.floor(1e6*Math.random())+1}),r}function autocomplete_extra_info_for_trip(e,t){return(e?'<li><i class="fa fa-clock-o" aria-hidden="true"></i>'+e+"</li>":"")+(t?'<li><i class="fa fa-map-marker" aria-hidden="true"></i>'+t+"</li>":"")}function autocomplete_extra_info_for_collection(e,t){return(e="<li>"+e+" "+VL.i18n_t("common.store_front.themes.flexi_theme.search.tours")+" </li>")+(t?"<i>\u2013</i><li style>"+VL.i18n_t("common.store_front.themes.flexi_theme.search.starting_from_text")+" "+t+"</li>":"")}function autocomplete_extra_info_for_sf_route(e){return e?'<li style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+e+" </li>":""}function render_search_autocomplete(e){var t,r="",a="";if("trips"==e.group)t=e.data._source.name,a=autocomplete_extra_info_for_trip(e.data._source.advertised_duration_string,e.data._source.advertised_location);else if("collections"==e.group)t=e.data._source.name,a=autocomplete_extra_info_for_collection(e.data._source.total_tours,e.data._source.advertised_price_string);else if("storefront_routes"==e.group)t=e.data._source.title,a=autocomplete_extra_info_for_sf_route(e.data._source.meta_description);else if("advanced_search"==e.group)a='<li style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+VL.i18n_t("common.store_front.themes.flexi_theme.search.advanced_search_result_desc")+"</li>",t=VL.i18n_t("common.store_front.themes.flexi_theme.search.advanced_search");else if("suggestion"==e.type)switch(t=e.data.title,e.data.page_type){case"trip":a=autocomplete_extra_info_for_trip(e.data.extra_data.advertised_duration_string,e.data.extra_data.advertised_location);break;case"trip_collection":a=autocomplete_extra_info_for_collection(e.data.extra_data.total_tours,e.data.extra_data.advertised_price_string)}return r=r+'<div class="item"><strong class="title">'+t+'</strong><ul class="location-list">'+a+"</ul></div>",jQuery(r)[0]}function search_autocomplete_ajax(e,t){e&&""!=e?$.get("/api/search/basic",{search_string:e},function(r){t(restructure_search_response(r,e))}):t(window.VL.search_suggestions)}function search_autocomplete_selected(e,t){if("advanced_search"==e.group)return VL.search_widgets[t].set_search_query(e.label),VL.search_widgets[t].apply_filters();var r;if("trips"==e.group){var a=e.data._source.client_id;sr=_.find(e.data._source.storefront_routes,function(e){return e.client_id==a}),r=_.isEmpty(sr)?"":sr.path}else r="collections"==e.group?e.data._source.storefront_route.path:"storefront_routes"==e.group?e.data._source.path:e.data.extra_data.route_url;return window.location.assign(r)}function render_search_autocomplete_group(e){var t="";switch(e){case"trips":t=VL.i18n_t("common.store_front.themes.flexi_theme.search.trips");break;case"collections":t=VL.i18n_t("common.store_front.themes.flexi_theme.search.collections");break;case"storefront_routes":t=VL.i18n_t("common.store_front.themes.flexi_theme.search.pages");break;case"advanced_search":t=VL.i18n_t("common.store_front.themes.flexi_theme.search.advanced_search");break;default:t=e}return $('<div class=" group ">'+t+"</div>")[0]}function init_search_autocomplete(e,t){VL.init_on_ready("search autocomplete",function(){e&&(autocomplete({input:e,preventSubmit:!0,debounceWaitMs:300,fetch:search_autocomplete_ajax,minLength:0,showOnFocus:!0,render:render_search_autocomplete,renderGroup:render_search_autocomplete_group,onSelect:function(e){return search_autocomplete_selected(e,t)}}),$(e).on("blur",function(){VL.search_widgets[t].set_search_query($(e).val(),!1)}))})}function search_modal_ajax(){var e=$("#searchModal"),t=e.find(".modal-body"),r=e.find("input.search");$.get("/api/search/basic",{search_string:r.val()},function(e){t.empty(),$.each(restructure_search_response(e),function(e,r){t.append(render_search_autocomplete(r))})})}function initAllSearchWidgets(){($("[data-search-widget-ref=header]").length>0||$(".search-opener").length>0)&&(window.VL.search_widgets.header={dest:"/search",auto_apply:!0}),$.each(window.VL.search_widgets,function(e,t){t=_.clone(window.VL.search_widgets[e]),window.VL.search_widgets[e]=new VLSearch(t.dest,t.auto_apply);var r=$("form[data-search-widget-ref="+e+"]");init_daterange_picker(r.find("input.tour-date"),e,t),init_search_autocomplete(r.find("input.js-search-select")[0],e)}),VL.init_on_ready("search modal",function(){loadjs.ready(["bootstrap3_modal","underscore"],function(){var e=$("#searchModal"),t=e.find("input.search");e.modal({show:!1}),init_search_autocomplete(t[0],"header"),$(".search-opener").click(function(){e.modal("show"),setTimeout(function(){t.focus()},500)})})}),VL.init_on_ready("segmented saerch dropdowns",function(){$(".search-widget .btn-group input").on("change",function(){if("radio"==$(this).attr("type")){let e=$(this).parents("label").text();$(this)[0].checked?$(this).parents(".btn-group").find(".dropdown-toggle .btn-val").html(e).parent().addClass("drop-open"):(e=$(this).parents(".btn-group").find("input[type=hidden]").val(),$(this).parents(".btn-group").find(".dropdown-toggle .btn-val").html(e).parent().removeClass("drop-open"))}else{$(this).parents(".btn-group").addClass("open");let e="";$(this).parents(".btn-group").find("input").each(function(t,r){r.checked&&"select_all_filter"!=r.name&&(e+=""==e?$(r).parents("label").text():", "+$(r).parents("label").text())}),""==e?(e=$(this).parents(".btn-group").find("input[type=hidden]").val(),$(this).parents(".btn-group").find(".dropdown-toggle .btn-val").html(e).parent().removeClass("drop-open")):$(this).parents(".btn-group").find(".dropdown-toggle .btn-val").html(e).parent().addClass("drop-open")}}),$(".search-widget .btn-group input[name=select_all_filter]").on("change",function(){$(this).parents(".btn-group").addClass("open");let e=this.checked;$(this).parents(".btn-group").find("input[type=checkbox]").each(function(t,r){"select_all_filter"!=r.name&&(r.checked=e,$(r).trigger("change"))})})})}!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).autocomplete=t()}(this,function(){"use strict";return function(e){function t(){h&&window.clearTimeout(h)}function r(){return!!g.parentNode}function a(){var e;E++,V=[],S="",f=void 0,(e=g.parentNode)&&e.removeChild(g)}function o(){for(;g.firstChild;)g.removeChild(g.firstChild);var t=function(e){var t=_.createElement("div");return t.textContent=e.label||"",t};e.render&&(t=e.render);var o=function(e){var t=_.createElement("div");return t.textContent=e,t};e.renderGroup&&(o=e.renderGroup);var n=_.createDocumentFragment(),i="#9?$";if(V.forEach(function(r){if(r.group&&r.group!==i){i=r.group;var s=o(r.group,S);s&&(s.className+=" group",n.appendChild(s))}var c=t(r,S);c&&(c.addEventListener("click",function(t){e.onSelect(r,k),a(),t.preventDefault(),t.stopPropagation()}),r===f&&(c.className+=" selected"),n.appendChild(c))}),g.appendChild(n),V.length<1){if(!e.emptyMsg)return void a();var s=_.createElement("div");s.className="empty",s.textContent=e.emptyMsg,g.appendChild(s)}g.parentNode||_.body.appendChild(g),function(){function t(){var e=_.documentElement,t=e.clientTop||_.body.clientTop||0,r=e.clientLeft||_.body.clientLeft||0,n=window.pageYOffset||e.scrollTop,i=window.pageXOffset||e.scrollLeft,s=(a=k.getBoundingClientRect()).top+k.offsetHeight+n-t,c=a.left+i-r;m.top=s+"px",m.left=c+"px",(o=window.innerHeight-(a.top+k.offsetHeight))<0&&(o=0),m.top=s+"px",m.bottom="",m.left=c+"px",m.maxHeight=o+"px"}if(r()){m.height="auto",m.width=k.offsetWidth+"px";var a,o=0;t(),t(),e.customize&&a&&e.customize(k,a,g,o)}}(),function(){var e=g.getElementsByClassName("selected");if(e.length>0){var t=e[0],r=t.previousElementSibling;if(r&&-1!==r.className.indexOf("group")&&!r.previousElementSibling&&(t=r),t.offsetTop<g.scrollTop)g.scrollTop=t.offsetTop;else{var a=t.offsetTop+t.offsetHeight,o=g.scrollTop+g.offsetHeight;a>o&&(g.scrollTop+=a-o)}}}()}function n(){r()&&o()}function i(){n()}function s(e){e.target!==g?n():e.preventDefault()}function c(e){for(var t=e.which||e.keyCode||0,a=0,o=[38,13,27,39,37,16,17,18,20,91,9];a<o.length;a++)if(t===o[a])return;t>=112&&t<=123||40===t&&r()||u(0)}function l(t){var n=t.which||t.keyCode||0;if(38===n||40===n||27===n){var i=r();if(27===n)a();else{if(!r||V.length<1)return;38===n?function(){if(V.length<1)f=void 0;else if(f===V[0])f=V[V.length-1];else for(var e=V.length-1;e>0;e--)if(f===V[e]||1===e){f=V[e-1];break}}():function(){if(V.length<1&&(f=void 0),f&&f!==V[V.length-1]){for(var e=0;e<V.length-1;e++)if(f===V[e]){f=V[e+1];break}}else f=V[0]}(),o()}return t.preventDefault(),void(i&&t.stopPropagation())}13===n&&(f&&(e.onSelect(f,k),a()),L&&t.preventDefault())}function d(){$&&u(1)}function u(r){var n=++E,i=k.value;i.length>=x||1===r?(t(),h=window.setTimeout(function(){e.fetch(i,function(e){E===n&&e&&(S=i,f=(V=e).length>0?V[0]:void 0,o())},0)},0===r?w:0)):a()}function p(){setTimeout(function(){_.activeElement!==k&&a()},200)}var f,h,_=document,g=_.createElement("div"),m=g.style,v=navigator.userAgent,y=-1!==v.indexOf("Firefox")&&-1!==v.indexOf("Mobile"),w=e.debounceWaitMs||0,L=e.preventSubmit||!1,b=y?"input":"keyup",V=[],S="",x=2,$=e.showOnFocus,E=0;if(void 0!==e.minLength&&(x=e.minLength),!e.input)throw new Error("input undefined");var k=e.input;return g.className="autocomplete "+(e.className||""),m.position="absolute",g.addEventListener("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),g.addEventListener("focus",function(){return k.focus()}),k.addEventListener("keydown",l),k.addEventListener(b,c),k.addEventListener("blur",p),k.addEventListener("focus",d),window.addEventListener("resize",i),_.addEventListener("scroll",s,!0),{destroy:function(){k.removeEventListener("focus",d),k.removeEventListener("keydown",l),k.removeEventListener(b,c),k.removeEventListener("blur",p),window.removeEventListener("resize",i),_.removeEventListener("scroll",s,!0),t(),a()}}}}),VLSearch.SINGLE_VALUE="single_value",VLSearch.MULTI_VALUE="multi_value",VLSearch.RANGE="range",VLSearch.prototype.clear_all_filters=function(){return this.filters={},this.apply_filters()},VLSearch.prototype.apply_filters=function(e){(e==undefined||e.reset_page)&&(this.filters.paginator={page:1}),this.url_params.filters=this.filters,window.location.assign(this.dest+"?"+$.param(this.url_params))},VLSearch.prototype.change_tab=function(e){return this.filters={active_tab:e},this.apply_filters()},VLSearch.prototype.sort_by=function(e){return this.filters={sort:{order_by:e}},this.apply_filters()},VLSearch.prototype.do_auto_apply=function(e){if(this.auto_apply)return this.apply_filters(e)},VLSearch.prototype.set_search_query=function(e,t){this.filters.search_string=e,(t===undefined||t)&&this.do_auto_apply()},VLSearch.prototype.toggle_radio_filter=function(e,t){var r=$(t);r.is(":checked")?this.add_filter(e,r.val()):this.remove_filter(e,r.val()),this.do_auto_apply()},VLSearch.prototype.toggle_checkbox_filter=function(e,t){var r=$(t);r.is(":checked")?this.add_filter(e,[r.val()]):this.remove_filter(e,r.val()),this.do_auto_apply()},VLSearch.prototype.toggle_range_filter=function(e,t,r,a){var o={low:t,high:r};$(a).is(":checked")?this.add_filter(e,[o]):this.remove_filter(e,o),this.do_auto_apply()},VLSearch.prototype.set_departure_date_filter=function(e,t){var r=VLSearch.format_date(t);this.filters.departure_date=this.filters.departure_date||[],0==this.filters.departure_date.length&&(this.filters.departure_date=[{}]),this.filters.departure_date[0][e]=r},VLSearch.prototype.add_filter=function(e,t){if(t){var r=this.filters[e];Array.isArray(t)&&r?(r.forEach(function(e){if(VLSearch.isEqual(e,t))return console.log("already present in filters",t),!1}),this.filters[e]=this.filters[e].concat(t)):this.filters[e]=t}else console.log("change_filter called with the following args, which needs to be handled better",arguments)},VLSearch.prototype.paginate_to=function(e){return this.filters.paginator={page:e},this.apply_filters({reset_page:!1})},VLSearch.prototype.remove_filter=function(e,t){if(t){var r=this.filters[e];Array.isArray(r)?this.filters[e]=r.filter(function(e){return!VLSearch.isEqual(e,t)}):delete this.filters[e]}else delete this.filters[e];this.do_auto_apply()},VLSearch.closeSearchFiltersSidebar=function(){jQuery("html").removeClass("search-sidebar-slider-active")},VLSearch.backToTop=function(){$("html").animate({scrollTop:0})},VLSearch.isEqual=function(e,t){return e===t||null!=e&&null!=t&&(Array.isArray(e)&&Array.isArray(t)?VLSearch.arrayIsEqual(e,t):VLSearch.objectIsEqual(e,t))},VLSearch.arrayIsEqual=function(e,t){if(e.length!=t.length)return!1;for(var r=0;r<e.length;r++)if(!VLSearch.isEqual(e[r],t[r]))return!1;return!0},VLSearch.objectIsEqual=function(e,t){try{var r=Object.keys(e).sort(),a=Object.keys(t).sort();return!!VLSearch.arrayIsEqual(r,a)&&!r.some(function(r){return!VLSearch.isEqual(e[r],t[r])})}catch(o){return!1}},VLSearch.format_date=function(e){var t=e.getFullYear(),r=(e.getMonth()+1).toString();return 1==r.length&&(r="0"+r),1==(e=e.getDate().toString()).length&&(e="0"+e),t+"-"+r+"-"+e},window.VL.search_widgets=window.VL.search_widgets||{},window.VL.init_on_ready("initAllSearchWidgets",initAllSearchWidgets);